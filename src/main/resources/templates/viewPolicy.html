<!DOCTYPE html>
<html lang="en" xmlns:th="https://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>View Policy</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div th:replace="navigationBar :: menu"></div>
<div class="container">

    <h2 class="mb-4 text-center">Insurance Policies</h2>


    <!-- FILTERS + SORT -->
    <div class="d-flex justify-content-end mb-3 gap-3">

        <!-- Status Filter -->
        <form th:action="@{/api/view/status}" method="get" id="statusForm"
              class="d-flex align-items-center gap-2 p-2 bg-light rounded shadow-sm">
            <label for="statusFilter" class="fw-bold text-primary mb-0">Filter by Status:</label>
            <select class="form-select form-select-sm w-auto border-primary rounded-pill shadow-sm"
                    id="statusFilter" name="status"
                    onchange="document.getElementById('statusForm').submit();">
                <option value="All" th:selected="${status == ''}">All</option>
                <option value="Active" th:selected="${status == 'Active'}">Active</option>
                <option value="Inactive" th:selected="${status == 'Inactive'}">Inactive</option>
                <option value="Pending" th:selected="${status == 'Pending'}">Pending</option>
                <option value="Success" th:selected="${status == 'Success'}">Success</option>
                <option value="Expired" th:selected="${status == 'Expired'}">Expired</option>
                <option value="Cancelled" th:selected="${status == 'Cancelled'}">Cancelled</option>
            </select>
        </form>

        <!-- Sorting Dropdown -->
        <form th:action="@{/api/view/sort}" method="get" id="sortForm"
              class="d-flex align-items-center gap-2 p-2 bg-light rounded shadow-sm">
            <label for="sortFilter" class="fw-bold text-success mb-0">Sort by:</label>
            <select class="form-select form-select-sm w-auto border-success rounded-pill shadow-sm"
                    id="sortFilter" name="order"
                    onchange="document.getElementById('sortForm').submit()">
                <option value="asc" th:selected="${order == 'asc'}">Policy Name (A → Z)</option>
                <option value="desc" th:selected="${order == 'desc'}">Policy Name (Z → A)</option>
            </select>
        </form>
        <!-- Search Filter -->
        <form th:action="@{/api/view/search}" method="get" id="filterSearch"
              class="d-flex align-items-center gap-2 p-2 bg-light rounded shadow-sm">

            <label for="searchInput" class="fw-bold text-info mb-0">Search:</label>

            <input type="text" id="searchInput" name="name" autofocus placeholder="Enter name or type"
                   class="form-control form-control-sm w-auto border-info rounded-pill shadow-sm"
                   th:value="${name}">

            <!-- Reset button -->
            <a th:href="@{/api/view}" class="btn btn-sm btn-secondary">
                <i class="bi bi-x-circle"></i> Clear
            </a>
        </form>
    </div>
    <!-- Policy Table -->
    <div class="table-responsive">
        <table id="policyTable" class="table table-bordered table-striped table-hover align-middle text-center">
            <thead class="table-dark">
            <tr>
                <th>S.no</th>
                <th>Policy Name</th>
                <th>Policy Type</th>
                <th>Policy Number</th>
                <th>Premium Amount</th>
                <th>Insurance Start Date</th>
                <th>Insurance End Date</th>
                <th>Insurance Status</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="policy,count : ${insurances}">
                <td th:text="${count.index+1}"></td>
                <td th:text="${policy.policyName}"></td>
                <td th:text="${policy.policyType}"></td>
                <td th:text="${policy.policyNumber}"></td>
                <td th:text="${policy.premiumAmount}"></td>
                <td th:text="${policy.startDate}"></td>
                <td th:text="${policy.endDate}"></td>
                <td>
                    <span class="badge bg-success" th:if="${policy.status == 'Active'}" th:text="${policy.status}"></span>
                    <span class="badge bg-danger" th:if="${policy.status == 'Inactive'}" th:text="${policy.status}"></span>
                    <span class="badge bg-secondary" th:if="${policy.status == 'Pending'}" th:text="${policy.status}"></span>
                    <span class="badge bg-primary" th:if="${policy.status == 'Success'}" th:text="${policy.status}"></span>
                    <span class="badge bg-dark" th:if="${policy.status == 'Expired'}" th:text="${policy.status}"></span>
                    <span class="badge bg-danger" th:if="${policy.status == 'Cancelled'}" th:text="${policy.status}"></span>
                </td>
                <td>
                    <a th:href="@{'edit/'+${policy.policyId}}" class="btn btn-sm btn-warning me-2">
                        <i class="bi bi-pencil"></i> Edit
                    </a>
                    <a th:href="@{'delete/'+${policy.policyId}}" class="btn btn-sm btn-danger">
                        <i class="bi bi-trash"></i> Delete
                    </a>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>
<script>
    let debounceTimer;

    document.getElementById("searchInput").addEventListener("input", function () {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            document.getElementById("filterSearch").submit();
            setTimeout(() => {
                document.getElementById("searchInput").value = "";
            }, 2000);

        }, 600);
    });

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
</body>
</html>
